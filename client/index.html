<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  <link href='https://fonts.googleapis.com/css?family=Raleway' rel='stylesheet' type='text/css'>
  <link href='https://fonts.googleapis.com/css?family=Handlee' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/4.0.0-alpha/css/bootstrap.min.css" />
  <link href='/assets/css/index.css' rel='stylesheet' type='text/css'>
</head>
<body>
  <div class="container-fluid">

    <div class="header row">
      <div class="header__left col-xs-2">

      </div>
      <div class="header__center col-xs-8 text-center">
      <img src="assets/images/header-center.png" />
        <h1>Feather a Friend</h1>
      </div>
      <div class="header__right col-xs-2">

      </div>
    </div>

    <div class="row">
      <div class="donate col-xs-12 col-lg-6">

        <div class="donate__header row">
          <div class="col-xs-12 text-center">
            <h2>To share the love <br class="hidden-sm-up" />and some food. <br class="hidden-lg-up" />Donate now!</h2>
          </div>
        </div>

        <div class="donate__forms row">
          <form id="single-donation-form" class="donation-form col-xs-12 col-sm-4 text-center" data-stripe-description="Feather a friend - single child donation" data-stripe-amount="50">
            <img src="/assets/images/donation-single.png" class="full-width" />
            <button type="submit" class="btn btn-success "><strong>$50</strong> Donation</button><br />
            <span>Feeds one child</span>
          </form>
          <form id="family-donation-form" class="donation-form col-xs-12 col-sm-4 text-center" data-stripe-description="Feather a friend - family donation" data-stripe-amount="75">
            <img src="/assets/images/donation-family.png" class="full-width" />
            <button type="submit" class="btn btn-success "><strong>$75</strong> Donation</button><br />
            <span>Feeds multiple children<br />in the same family</span>
          </form>
          <form id="other-donation-form" class="donation-form col-xs-12 col-sm-4 text-center" data-stripe-description="Feather a friend - other donation">
            <img src="/assets/images/donation-other.png" class="full-width" />
            <button type="submit" class="btn btn-success ">Other Donation</button><br />
            <span>Any gift helps</span>
            <input type="number" pattern="[0-9]*" min="5" step="1" data-stripe-amount class="form-control" placeholder="$5 - $500" required></input>
          </form>
        </div>

        <div class="donate__footer row">
          <div class="col-xs-12 text-center">
            <h4>Your donation will provide food to local children in the Frisco area who would be at risk of not having enough to eat over the holiday break when the schools are not providing meals.</h4><br />
            <a href="http://www.lovepacs.org/needs.html">Visit the Lovepacs info page to learn more about the needs in Frisco</a>
          </div>
        </div>
      </div>

      <div class="hidden-xs col-lg-1"></div>

      <div class="how-it-works col-xs-12 col-lg-5">
        <h2>How it works</h2>
        <div class="how-it-works__step row">
          <div class="col-xs-4 col-sm-2 col-lg-3 col-xl-2">
            <img src="/assets/images/step-honor.png" class="full-width" />
          </div>
          <div class="col-xs-8 col-sm-10 col-lg-9 col-xl-10">Donate in honor of a friend or family member</div>
        </div>

        <div class="how-it-works__step row">
          <div class="col-xs-4 col-sm-2 col-lg-3 col-xl-2">
            <img src="/assets/images/step-print.png" class="full-width" />
          </div>
          <div class="col-xs-8 col-sm-10 col-lg-9 col-xl-10">Download and print a turkey and two feathers</div>
        </div>

        <div class="how-it-works__step row">
          <div class="col-xs-4 col-sm-2 col-lg-3 col-xl-2">
            <img src="/assets/images/step-keep.png" class="full-width" />
          </div>
          <div class="col-xs-8 col-sm-10 col-lg-9 col-xl-10">Keep the turkey and attach your feather to remember that special person</div>
        </div>

        <div class="how-it-works__step row">
          <div class="col-xs-4 col-sm-2 col-lg-3 col-xl-2">
            <img src="/assets/images/step-give.png" class="full-width" />
          </div>
          <div class="col-xs-8 col-sm-10 col-lg-9 col-xl-10">Take the other feather and give it to your friend along with directions on how to keep sharing the love (and food) this holiday season</div>
        </div>

        <div class="how-it-works__step row">
          <div class="col-xs-4 col-sm-2 col-lg-3 col-xl-2">
            <img src="/assets/images/step-end-hunger.png" class="full-width" />
          </div>
          <div class="col-xs-8 col-sm-10 col-lg-9 col-xl-10">Help <a href="http://www.lovepacs.org">LovePacs</a> end hunger for children in the Frisco area while letting your friends know you love and appreciate them</div>
        </div>
      </div>
    </div>

    <div class="footer row">
      <div class="col-xs-5">
        <img src="/assets/images/lovepacs-logo.png" class="full-width" />
      </div>
      <div class="col-xs-7"><a href="www.lovepacs.org">LovePacs</a> exists to be an expression of God's love by engaging communities to serve children in need. We strive to make sure no child goes hungry while on breaks from school.</div>
    </footer>
  </div>

  <div class="overlay">
    <div class="overlay__content">
      <div class="overlay__content--processing">Processing ...</div>
      <div class="overlay__content--complete">
        <a href="/lovepacs-feather-a-friend.pdf" >
          <img src="assets/images/header-center.png" class="header-image"/><br />
          <img src="/assets/images/download.svg" class="icon-download"/>Download your turkey
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/js-cookie/2.0.4/js.cookie.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/lodash.js/3.10.1/lodash.min.js"></script>
  <script src="https://checkout.stripe.com/checkout.js"></script>

  <script>
    function stripeForm ($form, config) {
      var stripeInstance;
      var stripeConfig;

      function registerForm($form) {
        $form.find("button[type=submit]").on("click", displayCheckoutDialog);
      }

      function displayCheckoutDialog(e) {
        var data = {
          description: getDescription(),
          amount: getAmount()
        };

        // Only display the payment dialog if the
        // charge amount is at least a $1.00
        if (data.amount < 100) {
          $form.find("input[data-stripe-amount]").focus();
        } else {
          stripeInstance.open(data);
        }

        e.preventDefault();
      }

      function tokenCreated(token) {
        // Call the success callback if configured
        if (config.success) {
          config.success();
        }
        // Call the submit payment process
        // then call the original callback
        submitPayment(token).then(config.token);
      }

      function submitPayment(token) {
        var chargeConfig = _.defaults(stripeConfig.charge, {
          type: "POST",
          contentType: "application/json",
          dataType: "json",
        });
        var data = {
          description: getDescription(),
          amount: getAmount(),
          source: token.id,
          receipt_email: token.email
        };

        chargeConfig.data = JSON.stringify(data);
        return $.ajax(chargeConfig);
      }

      function getDescription() {
        return $form.attr("data-stripe-description") ? $form.attr("data-stripe-description") : undefined;
      }

      function getAmount() {
        var $amountField = $form.find("input[data-stripe-amount]");
        var amount = $amountField.length ? $amountField.val() : $form.attr("data-stripe-amount");
        return _.round(amount, 0) * 100;
      }

      function getAmountInCents(value) {
        return _.round(value, 0) * 100;
      }

      function init() {
        stripeConfig = _.cloneDeep(config);
        stripeConfig.token = tokenCreated;
        stripeInstance = StripeCheckout.configure(stripeConfig);

        registerForm($form)
      }

      init();
    }

    $(document).ready(function () {
      setTestModeCookie();
      var testMode = getTestMode();

      var tokenCreated = false;
      var $singleDonationForm = $("#single-donation-form");
      var $familyDonationForm = $("#family-donation-form");
      var $otherDonationForm = $("#other-donation-form");
      var stripeKeyLive = "pk_live_9pmNb8EVoamUQMKtvAYuorm5";
      var stripeKeyTest = "pk_test_Cdnp4m36AXNcBVaZISSFwjZ1";
      var stripeKey = testMode ? stripeKeyTest : stripeKeyLive;

      stripeConfig = {
        key: stripeKey,
        image: "/assets/images/lovepacs-checkout-logo.png",
        name: "LovePacs",
        locale: "auto",
        opened: showOverlay,
        closed: hideOverlay,
        success: trackSuccess,
        token: showDownload,
        charge: {
          url: "/payment",
          type: "POST",
          contentType: "application/json",
          dataType: "json",
        }
      };

      if (testMode) {
        console.log("Starting test mode");
        console.log("stripeConfig: ");
        console.log(stripeConfig);
      }

      stripeForm($singleDonationForm, stripeConfig);
      stripeForm($familyDonationForm, stripeConfig);
      stripeForm($otherDonationForm, stripeConfig);

      function setTestModeCookie() {
        // set the testMode based upon the presence of ?mode=test in the querystring
        if (window.location.search.indexOf("mode=test") > -1) {
          Cookies.set("mode", "test");
        } else {
          Cookies.remove("mode");
        }
      }

      function getTestMode() {
        return Cookies.get("mode") === "test";
      }

      function trackSuccess() {
        tokenCreated = true;
        $(".overlay__content--processing").show();
      }

      function hideOverlay() {
        // Only hide the overlay if the user closed the dialog
        if (!tokenCreated) {
          $(".overlay").hide();
        }
      }
      function showOverlay() {
        $(".overlay").show();
      }

      function showDownload() {
        $(".overlay").show();
        $(".overlay__content--processing").hide();
        $(".overlay__content--complete").show();
      }
    });
  </script>
</body>
</html>
